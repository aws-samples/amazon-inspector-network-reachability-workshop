



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="The workshop will demonstrate how you can validate their network configuration without needing to have a deep networking background by using Inspectors Network Reachability report. You will learn how this report can help them find misconfigurations in the architecture or behaviors they might not have expected. The demo will finish with using the Network Reachability report findings integrated with other Security Services to remediate these issues.">
      
      
        <link rel="canonical" href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop/04-integration-and-remediation/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Module 4: Integration and Remediation - Finding and addressing Network Misconfigurations on AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#module-4-integration-and-remediation" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop" title="Finding and addressing Network Misconfigurations on AWS" class="md-header-nav__button md-logo">
          
            <img src="../images/aws_smile_logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Finding and addressing Network Misconfigurations on AWS
            </span>
            <span class="md-header-nav__topic">
              
                Module 4: Integration and Remediation
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    mikewest82/InspectorNetworkReachability
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." title="Overview" class="md-tabs__link md-tabs__link--active">
        Overview
      </a>
    
  </li>

      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop" title="Finding and addressing Network Misconfigurations on AWS" class="md-nav__button md-logo">
      
        <img src="../images/aws_smile_logo.png" width="48" height="48">
      
    </a>
    Finding and addressing Network Misconfigurations on AWS
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    mikewest82/InspectorNetworkReachability
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-environment-setup/" title="Module 1: Environment Build and Configuration" class="md-nav__link">
      Module 1: Environment Build and Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-running-inspector/" title="Module 2: Running the Inspector Report" class="md-nav__link">
      Module 2: Running the Inspector Report
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03-evaluate-findings/" title="Module 3: Evaluating Findings" class="md-nav__link">
      Module 3: Evaluating Findings
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="Module 4: Integration and Remediation" class="md-nav__link md-nav__link--active">
      Module 4: Integration and Remediation
    </a>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../05-cleanup/" title="Module 5: Cleanup" class="md-nav__link">
      Module 5: Cleanup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../presentation-notes/" title="Presentation Notes" class="md-nav__link">
      Presentation Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop/edit/master/docs/04-integration-and-remediation.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="module-4-integration-and-remediation">Module 4 - Integration and Remediation</h1>
<p>In the previous module you identified issues with the network configuration and began remediating them. In this module you will leverage additional AWS services to deploy automatic remediations to known bad configurations. </p>
<h1 id="integrating-inspector-with-other-aws-security-services">Integrating Inspector with other AWS Security Services</h1>
<p>In the previous module you configured your assessment to send findings to a Simple Notification Service topic. Now you are going to use that to trigger a Lambda function to remediate common findings. The CloudFormation template has deployed a Lambda function to block SSH access to misconfigured instances and included it in the CloudFormation template. Let's build the connection from SNS to Lambda and review the code.</p>
<ol>
<li>
<p>Go to the Amazon Simple Notification Service console</p>
</li>
<li>
<p>Click on Topics on the left hand side</p>
<p><img alt="" src="../images/mod4-1-sns-topics.png" /></p>
</li>
<li>
<p>Click on the Topic named "InspectorAutomation"</p>
<p>In order to have the SNS topic send data to Lambda, you need to create a subscription. You should see the subscriptions window on the bottom and it should be empty.</p>
</li>
<li>
<p>Click Create Subscription</p>
<p><img alt="" src="../images/mod4-2-subscription.png" /></p>
</li>
<li>
<p>The Topic ARN should be filled out, but if it's not click on it and select the topic.</p>
</li>
<li>
<p>Click on the Protocol drop down and select AWS Lambda</p>
</li>
<li>
<p>You should now see another dropdown. Click on it and select the one Lambda function that's there.</p>
<p><img alt="" src="../images/mod4-3-create-subscription.png" /></p>
</li>
<li>
<p>Click Create Subscription</p>
<p>We've now configured SNS to send any alerts it receives to our Lambda function. Our Lambda function is configured to only respond to specific findings in specific ways. If you're interested in reviewing the Lambda function you can go to the Lambda console. The relevant piece of code for this activity are shown below:</p>
<p><img alt="" src="../images/mod4-13-lambda-code.png" /></p>
<p>You can see here that the Lambda code adds a Network ACL line that blocks SSH from the internet to any instance that has SSH open to the internet.</p>
<p>To trigger this you need to have Inspector submit a finding to SNS. Rather than wait 15 minutes for Inspector to finish an assessment though, you can simulate this action.</p>
</li>
<li>
<p>While still in SNS click on Topics on the left hand side</p>
</li>
<li>
<p>Click on the Topic named "InspectorAutomation"</p>
</li>
<li>
<p>In the top right click on the button that says "Publish Message"</p>
<p><img alt="" src="../images/mod4-4-publish.png" /></p>
<p>Using the ARN you copied down in Step 3 of Module 3 you are going to publish a fake SNS message using the appropriate ARN to kick off the Lambda function.</p>
<div class="admonition info">
<p class="admonition-title">What ARN?</p>
<p>If you don't have the ARN, you can go back to Inspector and copy the ARN from the Medium finding.</p>
</div>
</li>
<li>
<p>Paste the ARN into the appropriate place in the following text: {replace the "<strong>INSERT ARN HERE</strong>" with your arn)</p>
<p><code>{"template":"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d/template/0-5e6f7g8h","run":"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d/template/0-5e6f7g8h/run/0-9i0j1k2l","time":"2019-04-09T00:00:01.401Z","finding":"INSERT ARN HERE","event":"FINDING_REPORTED","target":"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d"}</code></p>
</li>
<li>
<p>Paste the SNS message from above in the "Message body to send to the endpoint" text box</p>
</li>
<li>
<p>Leave all the other fields empty</p>
<p><img alt="" src="../images/mod4-5-message.png" /></p>
</li>
<li>
<p>Click "Publish Message"</p>
<div class="admonition info">
<p class="admonition-title">If you're bored</p>
<p><p style="font-size:16px;">
Alternatively if you have the time, you can re-run the Inspector report and watch once it's complete to see if the change was made.
</p></p>
</div>
<p>To confirm that it worked you will check the Network ACL's.</p>
</li>
<li>
<p>Click on Services on the top right and click on VPC</p>
</li>
<li>
<p>On the left hand navigation click on Network ACLs</p>
<p><img alt="" src="../images/mod4-6-vpc-nacls.png" /></p>
</li>
<li>
<p>Since the Proof of Concept VPC is the one with the misconfiguration, click on the ACL associated with that VPC</p>
<p><img alt="" src="../images/mod4-7-nacls.png" /></p>
</li>
<li>
<p>On the bottom navigation, click on "Inbound Rules"</p>
<p><img alt="" src="../images/mod4-8-nacl-rules.png" /></p>
<p>Do you see a rule blocking SSH?</p>
<p>But if SSH is completely blocked to the instance, how can legitimate administrators configure the machine? Well, they can modify the Security Group and then the NACL through their Change Process. But if they want to make sure the instance wasn't compromised there's another option.</p>
</li>
<li>
<p>Click on Services on the top right and click on Systems Manager</p>
</li>
<li>
<p>On the left hand navigation, click on Session Manager</p>
<p><img alt="" src="../images/mod4-9-systems-manager.png" /></p>
</li>
<li>
<p>On the right hand side click on Start Session</p>
<p><img alt="" src="../images/mod4-10-session-manager.png" /></p>
<p>Do you remember the instance ID with the misconfigured Security Group? If not, don't worry, it was the PoC Web Server for AZ2</p>
</li>
<li>
<p>Click on the radio button next to the instance</p>
</li>
<li>
<p>Click Start Session</p>
<p><img alt="" src="../images/mod4-11-session-instances.png" /></p>
</li>
<li>
<p>Type "ping 8.8.8.8" - Are you able to ping out to the world? Hit Cntl-C when you're ready to move on.</p>
</li>
<li>
<p>Type "whoami" - What user are you logged into the box as?</p>
<p><img alt="" src="../images/mod4-12-active-session.png" /></p>
<p>This looks just like an SSH session! Instead though, this is a proxy created by the AWS System Manager Agent installed on the AMI. With the AWS Systems Manager Session Manager feature you can create an SSH-like access to devices that don't have port 22 open at all. All that's necessary is to allow traffic to the Systems Manager Endpoint over port 443 and return traffic.</p>
</li>
<li>
<p>When you're done, hit "Terminate" in the top right corner</p>
</li>
<li>
<p>Confirm you want to terminate the session.</p>
</li>
</ol>
<p>So now we've learned how you can use Inspector to kick off a Lambda function and automatically remediate potentially risks configurations. Additionally, you've seen how when you isolate instances from the world, you can still use AWS services to securely access them and perform troubleshooting or incidence response.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p><p style="font-size:16px;">
Now since there are some instances still open to the internet and potentially vulnerable, let's clean up what's been built.
</p></p>
</div>
<p><a href="../05-cleanup/">Cleanup</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../03-evaluate-findings/" title="Module 3: Evaluating Findings" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 3: Evaluating Findings
              </span>
            </div>
          </a>
        
        
          <a href="../05-cleanup/" title="Module 5: Cleanup" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 5: Cleanup
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>